// ============================================
// BGFI WhatsApp Marketing SaaS - Database Schema
// Avec Supabase pgvector pour le RAG
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(OPERATOR)
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  
  // Relations
  campaigns Campaign[]
  apiKeys   ApiKey[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// ============================================
// Campaigns
// ============================================
model Campaign {
  id          String          @id @default(uuid())
  name        String
  type        CampaignType
  status      CampaignStatus  @default(DRAFT)
  description String?
  
  // Statistics
  sent        Int             @default(0)
  delivered   Int             @default(0)
  read        Int             @default(0)
  clicked     Int             @default(0)
  failed      Int             @default(0)
  
  // Configuration
  templateId  String
  template    Template        @relation(fields: [templateId], references: [id])
  segment     Segment
  variables   Json?           @default("{}")
  
  // Scheduling
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  
  // Relations
  messages    Message[]
  
  // Timestamps
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  createdBy   String
  user        User            @relation(fields: [createdBy], references: [id])
  
  @@index([status])
  @@index([createdAt])
  @@index([createdBy])
  @@map("campaigns")
}

// ============================================
// Templates (WhatsApp)
// ============================================
model Template {
  id          String           @id @default(uuid())
  name        String
  displayName String
  category    TemplateCategory
  content     String
  variables   String[]         @default([])
  language    String           @default("fr")
  
  // Meta approval status
  status      TemplateStatus   @default(PENDING)
  metaId      String?          // WhatsApp template ID from Meta
  approvedAt  DateTime?
  rejectedAt  DateTime?
  rejectionReason String?
  
  // Relations
  campaigns   Campaign[]
  
  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@index([status])
  @@index([category])
  @@map("templates")
}

// ============================================
// Contacts
// ============================================
model Contact {
  id            String        @id @default(uuid())
  phone         String        @unique
  email         String?
  name          String?
  
  // Segmentation
  segment       Segment       @default(ACTIVE)
  tags          String[]      @default([])
  
  // Metadata
  lastActivity  DateTime?
  status        ContactStatus @default(ACTIVE)
  
  // WhatsApp specific
  whatsappId    String?       // WhatsApp Business API contact ID
  optedIn       Boolean       @default(false)
  optedInAt     DateTime?
  
  // Relations
  messages      Message[]
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([segment])
  @@index([status])
  @@index([phone])
  @@map("contacts")
}

// ============================================
// Messages
// ============================================
model Message {
  id          String        @id @default(uuid())
  
  // Relations
  campaignId  String?
  campaign    Campaign?     @relation(fields: [campaignId], references: [id])
  contactId   String
  contact     Contact       @relation(fields: [contactId], references: [id])
  
  // Content
  content     String
  type        MessageType   @default(TEXT)
  
  // Status tracking
  status      MessageStatus @default(PENDING)
  externalId  String?       // WhatsApp message ID (wamid)
  
  // Timestamps
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  failedAt    DateTime?
  error       String?
  
  createdAt   DateTime      @default(now())
  
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// Knowledge Documents (RAG avec Supabase)
// ============================================
model KnowledgeDocument {
  id          String         @id @default(uuid())
  name        String
  type        String         // pdf, docx, xlsx, etc.
  size        Int            // in bytes
  path        String?        // storage path (optionnel avec Supabase)
  
  // Indexing status
  status      DocumentStatus @default(PROCESSING)
  chunks      Int            @default(0)
  indexedAt   DateTime?
  
  // Relations
  chunks_data KnowledgeChunk[]
  
  // Timestamps
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@index([status])
  @@map("knowledge_documents")
}

// ============================================
// Knowledge Chunks (pour pgvector)
// ============================================
model KnowledgeChunk {
  id           String   @id @default(uuid())
  documentId   String
  document     KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Content
  content      String
  
  // Vector embedding (3072 dimensions pour text-embedding-3-large)
  // Note: Prisma ne supporte pas nativement le type vector
  // On utilise une migration SQL personnalisée pour créer ce champ
  embedding    Unsupported("vector(3072)")?
  
  // Metadata
  metadata     Json     @default("{}")
  
  // Timestamps
  createdAt    DateTime @default(now())
  
  @@index([documentId])
  // Index pour la recherche vectorielle (créé via migration SQL)
  @@map("knowledge_chunks")
}

// ============================================
// API Keys
// ============================================
model ApiKey {
  id          String    @id @default(uuid())
  name        String
  key         String    @unique
  
  // Permissions
  permissions String[]  @default([])
  
  // Usage tracking
  lastUsedAt  DateTime?
  usageCount  Int       @default(0)
  
  // Status
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  
  // Relations
  createdBy   String
  user        User      @relation(fields: [createdBy], references: [id])
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  @@index([key])
  @@map("api_keys")
}

// ============================================
// Chat Sessions (RAG)
// ============================================
model ChatSession {
  id          String    @id @default(uuid())
  contactId   String?
  
  // Messages
  messages    Json[]    @default([])
  
  // Metadata
  source      String    @default("web") // web, whatsapp, api
  userAgent   String?
  ipAddress   String?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([contactId])
  @@index([createdAt])
  @@map("chat_sessions")
}

// ============================================
// Enums
// ============================================

enum Role {
  ADMIN
  MANAGER
  OPERATOR
}

enum CampaignType {
  REACTIVATION
  TUTORIAL
  NOTIFICATION
  FEATURE
  MARKETING
  ALERT
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Segment {
  ALL
  ACTIVE
  INACTIVE
  NEW
  PREMIUM
  VIP
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BLOCKED
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  TEMPLATE
  LOCATION
  BUTTON
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

enum DocumentStatus {
  PROCESSING
  INDEXED
  FAILED
}
